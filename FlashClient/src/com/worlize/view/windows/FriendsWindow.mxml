<?xml version="1.0" encoding="utf-8"?>
<components:WorlizeFloatingPanel xmlns:fx="http://ns.adobe.com/mxml/2009" 
								 xmlns:s="library://ns.adobe.com/flex/spark" 
								 xmlns:mx="library://ns.adobe.com/flex/mx"
								 xmlns:components="com.worlize.view.components.*"
								 titleBarColor="#1076a4"
								 showTitle="false"
								 showCloseButton="false"
								 mouseDownOutside="handleMouseDownOutside(event)"
								 width="375" minHeight="200" maxHeight="400" xmlns:code="http://code.google.com/p/flexlib/">
	
	<fx:Script>
		<![CDATA[
			import com.worlize.model.FriendsList;
			import com.worlize.model.FriendsListEntry;
			import com.worlize.model.PendingFriendsListEntry;
			import com.worlize.view.itemrenderers.FriendListItemRenderer;
			import com.worlize.view.itemrenderers.PendingFriendInvitationItemRenderer;
			
			import mx.events.CloseEvent;
			import mx.managers.PopUpManager;
			import mx.utils.object_proxy;
			
			import spark.skins.spark.DefaultItemRenderer;
			
			private static var _open:Boolean = false;
			private static var _instance:FriendsWindow;
			private static var closedAt:Date;
			
			[Bindable]
			private var friendsList:FriendsList = FriendsList.getInstance();
			
			private function handleMouseDownOutside(event:MouseEvent):void {
				FriendsWindow.close();
			}
			
			public static function get isOpen():Boolean {
				return _open;
			}
			
			public static function open(parent:DisplayObject):void {
				if (closedAt && closedAt.valueOf() > (new Date()).valueOf() - 200) {
					return;
				}
				
				if (_open) {
					PopUpManager.bringToFront(_instance);
					_instance.setFocus();
				}
				else {
					_instance = new FriendsWindow();
					_instance.addEventListener(CloseEvent.CLOSE, function(event:CloseEvent):void {
						close();
					});
					_instance.friendsList.load();
					PopUpManager.addPopUp(_instance, parent);
					_instance.x = 130;
					_instance.y = 30;
					_open = true;
				}
			}
			
			public static function close():void {
				if (_open && _instance) {
					PopUpManager.removePopUp(_instance);
					_open = false;
					_instance = null;
					closedAt = new Date();
				}
			}
			
			private function selectFriendsListItemRenderer(item:Object):ClassFactory {
				if (item is FriendsListEntry) {
					return new ClassFactory(FriendListItemRenderer);
				}
				else if (item is PendingFriendsListEntry) {
					return new ClassFactory(PendingFriendInvitationItemRenderer);
				}
				else {
					return new ClassFactory(DefaultItemRenderer);
				}
			}

		]]>
	</fx:Script>
	
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->

	</fx:Declarations>
	
	
	<s:VGroup width="100%" minHeight="300" maxHeight="500" gap="0">
		<s:DataGroup enabled="{friendsList.state == FriendsList.STATE_READY}"
				width="100%" height="100%" dataProvider="{friendsList.friends}"
				itemRendererFunction="selectFriendsListItemRenderer">
			<s:layout>
				<s:VerticalLayout gap="0" />
			</s:layout>
		</s:DataGroup>
		<!--
		<components:PendingFriendInvitationsList />
		
		<s:List itemRenderer="FriendListItemRenderer" />
		-->
		<components:BetaInvitationForm width="100%" />
	</s:VGroup>
	
</components:WorlizeFloatingPanel>
